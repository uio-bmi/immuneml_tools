<tool id="immuneml_dataset" name="Create Dataset with Reports" version="@VERSION@.0">
    <description></description>
<!--    <macros>-->
<!--        <import>prod_macros.xml</import>-->
<!--    </macros>-->
<!--    <expand macro="requirements" />-->
  <command><![CDATA[
      source /storage/iml_env/bin/activate &&

      #if $import_cond.import_type == "history"
        #if $import_cond.iml_input
           cp -r ${import_cond.iml_input.extra_files_path}/galaxy_dataset/* . &&
	   (mv repertoires/* . &>/dev/null || :) &&
	   rm -rf repertoires &&
        #end if
      #else
        #set $input_orig_names = []
        #for $input in $import_cond.data_input
          #if $input
            #set input_orig_names += ["./"+str($input.element_identifier)]
            ([ -e ./"$input.element_identifier" ] && echo "File '$input.element_identifier' already exists in the input folder, skipping." || ln -s $input "$input.element_identifier") &&
          #end if
        #end for
      #end if

      #if $import_cond.import_type == "yaml"
        cp $yaml_input create_dataset.yaml &&
      #else
        python3 '$__tool_directory__/build_dataset_overview_yaml_wrapper.py'
        --output_path . --file_name create_dataset.yaml
        #for $report_name in $import_cond.reports
          --"$report_name" True
        #end for
        --label_name "$import_cond.report_param_section.report_label"
        #if $import_cond.import_type == "files"
          #if $import_cond.dataset_cond.dataset_type == "repertoire"
              --is_repertoire True
              --format "$import_cond.dataset_cond.metadata_cond.data_format"
              #if $import_cond.dataset_cond.metadata_cond.data_format != "IReceptor"
                  --metadata_file "$import_cond.dataset_cond.metadata_cond.metadata_input" &&
                  cp $import_cond.dataset_cond.metadata_cond.metadata_input "$import_cond.dataset_cond.metadata_cond.metadata_input.element_identifier"
              #end if
          #else
              --is_repertoire False
              --format "$import_cond.dataset_cond.data_format"
              --metadata_columns "$import_cond.dataset_cond.metadata_columns"
              #if $import_cond.dataset_cond.dataset_type == "sequence"
                  --paired False
              #elif $import_cond.dataset_cond.dataset_type == "receptor"
                  --paired True
                  --receptor_chains $import_cond.dataset_cond.receptor_type
              #end if
          #end if
        #else
            --existing_dataset True
        #end if
      #end if

      && cp ./create_dataset.yaml ${specs} &&

      immune-ml ./create_dataset.yaml ${html_outfile.files_path} --tool DatasetGenerationOverviewTool &&

      mv ${html_outfile.files_path}/index.html ${html_outfile} &&
      mv ${html_outfile.files_path}/immuneML_output.zip $archive
      ]]>
  </command>
  <inputs>
      <conditional name="import_cond">
          <param type="select" name="import_type" label="How would you like to import your dataset?" display="radio"
                 help="An imported dataset can be used as input for other Galaxy tools.
                 Furthermore, this tool allows you to run data analysis report(s) on a new or existing immuneML dataset.
                 Advanced import parameters (and reports) can be run through the YAML specification.">
              <option value="files">Import a new dataset from files</option>
              <option value="history">Select an existing dataset from the Galaxy history</option>
              <option value="yaml">Advanced data import through YAML specification</option>
          </param>
          <when value="files">
              <conditional name="dataset_cond">
                  <param type="select" name="dataset_type" label="Dataset type" display="radio" help="Repertoire datasets
                   should be used when making predictions per repertoire, such as predicting a disease state. Sequence or
                    receptor datasets should be used when predicting values for unpaired (single-chain) and paired immune
                     receptors respectively, like antigen specificity.">
                      <option value="repertoire">Repertoire dataset</option>
                      <option value="sequence">Sequence dataset (single chain)</option>
                      <option value="receptor">Receptor dataset (paired chains)</option>
                  </param>
                  <when value="repertoire">
                      <conditional name="metadata_cond">
                          <param type="select" name="data_format" label="Data format" display="radio">
                              <option value="AIRR">AIRR</option>
                              <option value="IReceptor">iReceptor Gateway</option>
                              <option value="ImmunoSEQRearrangement">immunoSEQ: rearrangement-level files</option>
                              <option value="ImmunoSEQSample">immunoSEQ: sample-level files</option>
                              <option value="MiXCR">MiXCR</option>
                              <option value="VDJdb">VDJdb</option>
                              <option value="TenxGenomics">10x Genomics ‘Clonotype consensus annotations’ (CSV)</option>
                          </param>
                          <when value="AIRR">
                              <param name="metadata_input" type="data" format="txt" label="Metadata file"
                                     multiple="false"
                                     help="The metadata file describes metadata information for all repertoires included in the dataset. Every repertoire ARR file described in the metadata file must be selected under 'Data files'."/>
                          </when>
                          <when value="ImmunoSEQRearrangement">
                              <param name="metadata_input" type="data" format="txt" label="Metadata file"
                                     multiple="false"
                                     help="The metadata file describes metadata information for all repertoires included in the dataset. Every repertoire immunoSEQ rearrangement file described in the metadata file must be selected under 'Data files'."/>
                          </when>
                          <when value="ImmunoSEQSample">
                              <param name="metadata_input" type="data" format="txt" label="Metadata file"
                                     multiple="false"
                                     help="The metadata file describes metadata information for all repertoires included in the dataset. Every repertoire immunoSEQ sample file described in the metadata file must be selected under 'Data files'."/>
                          </when>
                          <when value="MiXCR">
                              <param name="metadata_input" type="data" format="txt" label="Metadata file"
                                     multiple="false"
                                     help="The metadata file describes metadata information for all repertoires included in the dataset. Every repertoire MiXCR file described in the metadata file must be selected under 'Data files'."/>
                          </when>
                          <when value="VDJdb">
                              <param name="metadata_input" type="data" format="txt" label="Metadata file"
                                     multiple="false"
                                     help="The metadata file describes metadata information for all repertoires included in the dataset. Every repertoire VDJdb file described in the metadata file must be selected under 'Data files'."/>
                          </when>
                          <when value="TenxGenomics">
                              <param name="metadata_input" type="data" format="txt" label="Metadata file"
                                     multiple="false"
                                     help="The metadata file describes metadata information for all repertoires included in the dataset. Every repertoire 10x Genomics file described in the metadata file must be selected under 'Data files'."/>
                          </when>
                      </conditional>
                  </when>
                  <when value="sequence">
                      <param type="select" name="data_format" label="Data format" display="radio">
                          <option value="AIRR">AIRR</option>
                          <option value="IReceptor">iReceptor Gateway</option>
                          <option value="ImmunoSEQRearrangement">ImmunoSEQ: rearrangement-level files</option>
                          <option value="ImmunoSEQSample">ImmunoSEQ: sample-level files</option>
                          <option value="MiXCR">MiXCR</option>
                          <option value="VDJdb">VDJdb</option>
                          <option value="TenxGenomics">10xGenomics ‘Clonotype consensus annotations’ (CSV)</option>
                      </param>
                      <param type="text" name="metadata_columns" optional="false" label="Metadata columns" help="Please
                      specify the names of the columns that contain metadata. The metadata columns specified here can be
                      used as labels for prediction. Multiple metadata columns may be specified and separated by comma,
                      for example: Epitope,Epitope gene,Epitope species"/>
                  </when>
                  <when value="receptor">
                      <param type="select" name="data_format" label="Data format" display="radio">
                          <option value="AIRR">AIRR</option>
                          <option value="IReceptor">iReceptor Gateway</option>
                          <option value="VDJdb">VDJdb</option>
                          <option value="TenxGenomics">10xGenomics ‘Clonotype consensus annotations’ (CSV)</option>
                      </param>
                      <param type="select" name="receptor_type" label="Receptor type" display="radio">
                          <option value="TRA_TRB">T cell alpha/beta</option>
                          <option value="TRG_TRD">T cell gamma/delta</option>
                          <option value="IGH_IGL">B cell heavy/light</option>
                          <option value="IGH_IGK">B cell heavy/kappa</option>
                      </param>
                      <param type="text" name="metadata_columns" optional="false" label="Metadata columns" help="Please
                      specify the names of the columns that contain metadata. The metadata columns specified here can be
                      used as labels for prediction. Multiple metadata columns may be specified and separated by comma,
                      for example: Epitope,Epitope gene,Epitope species"/>
                  </when>
              </conditional>
              <param name="data_input" type="data" multiple="true" label="Data files" min="1" max="2000"
                     help="This field should include individual repertoire or receptor files, or iReceptor zip files. Multiple files can be selected by holding down the control/command or shift key, or by clicking 'browse datasets' (folder button on the right). Important: make sure all the files you want to include in the dataset are highlighted in blue or gray."/>

              <param name="reports" type="select" label="Data analysis reports" help="" display="checkboxes" multiple="true">
                  <option value="sequence_length_report">Sequence length distribution</option>
                  <option value="sequence_count_report">Sequence count distribution</option>
                  <option value="amino_acid_report">Amino acid frequency distribution</option>
                  <option value="vj_gene_report">VJ gene distribution</option>
              </param>

              <section name="report_param_section" title="Advanced report options" >
                  <param type="text" name="report_label" optional="false" label="Analysis label for reports"
                         help="By specifying an analysis label, report results will be separated by the label value.
               E.g., the V and J gene distribution for 'diseased' and 'healthy' repertoires can be plotted in different colors.
               Note that the given label name must be a valid label for the dataset. If you have previously imported
               an immuneML dataset, the valid label name(s) are displayed in the summary HTML page."/>
              </section>

          </when>
          <when value="history">
              <param name="iml_input" type="data" format="immuneml_receptors.html" label="immuneML dataset"
                     optional="false"
                     help="This field accepts a previously generated immuneML dataset."/>

              <param name="reports" type="select" label="Data analysis reports" help="" display="checkboxes" multiple="true">
                  <option value="sequence_length_report">Sequence length distribution</option>
                  <option value="sequence_count_report">Sequence count distribution</option>
                  <option value="amino_acid_report">Amino acid frequency distribution</option>
                  <option value="vj_gene_report">VJ gene distribution</option>
              </param>

              <section name="report_param_section" title="Advanced report options" >
                  <param type="text" name="report_label" optional="false" label="Analysis label for reports"
                         help="By specifying an analysis label, report results will be separated by the label value.
               E.g., the V and J gene distribution for 'diseased' and 'healthy' repertoires can be plotted in different colors.
               Note that the given label name must be a valid label for the dataset. If you have previously imported
               an immuneML dataset, the valid label name(s) are displayed in the summary HTML page."/>
              </section>
          </when>

          <when value="yaml">
              <param name="yaml_input" type="data" format="txt" label="YAML specification" multiple="false"/>
              <param name="data_input" type="data" multiple="true" label="Data files" min="1" max="2000"
                     help="This field should include individual repertoire or receptor files, or iReceptor zip files. Multiple files can be selected by holding down the control/command or shift key, or by clicking 'browse datasets' (folder button on the right). Important: make sure all the files you want to include in the dataset are highlighted in blue or gray."/>
          </when>
      </conditional>

  </inputs>
    <outputs>
        <data format="txt" name="specs" label="create_dataset.yaml"/>
        <data format="zip" name="archive" label="Archive: immuneML dataset"/>
        <data format="immuneml_receptors.html" name="html_outfile" label="immuneML dataset"/>
    </outputs>



    <help><![CDATA[

        This Galaxy tool allows users to import data from various file formats and create an 'immuneML dataset'
        in a standardized format. To run any of the immuneML Galaxy tools, the immuneML dataset can be selected
        from the Galaxy history. Furthermore, this tool can be used to run optional analysis reports to gain insight about the dataset.
        This can be done either when importing a new dataset, or by selecting an existing dataset from the Galaxy history.

        Before creating a dataset, the relevant data files must first be uploaded to the Galaxy interface. This can be done either
        by uploading files from your local computer (use the 'Upload file' tool under the 'Get local data' menu), or by fetching
        remote data from the iReceptor Plus Gateway or VDJdb (see `How to import remote AIRR datasets in Galaxy <https://docs.immuneml.uio.no/latest/galaxy/galaxy_import_remote_data.html>`_).

        For the exhaustive documentation of this tool and more information about immuneML datasets, see the tutorial
        `How to make an immuneML dataset in Galaxy <https://docs.immuneml.uio.no/latest/galaxy/galaxy_dataset.html>`_.

        **Tool output**

        This Galaxy tool will produce the following history elements:

        - immuneML dataset: a sequence, receptor or repertoire dataset which can be used as an input to other immuneML tools.
          The history element contains a summary HTML page describing general characteristics of the dataset, including the name of the dataset
          (which is used in the dataset definition of a yaml specification), the dataset type and size, and available labels.
          When running optional reports, the report results are shown here as well.

        - Archive: immuneML dataset: a .zip file containing the complete output folder as it was produced by immuneML.
          This folder contains the raw immuneML dataset files, optional report results and log file.

        - create_dataset.yaml: the YAML specification file that was used by immuneML to create the dataset.
          This file can be downloaded and altered (for example to use non-standard import parameters),
          and run again using the 'Advanced' interface.

    ]]>
    </help>

</tool>
